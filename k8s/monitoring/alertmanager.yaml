apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: config
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@fraud-detection.local'
      smtp_auth_username: 'your-email@gmail.com'
      smtp_auth_password: 'your-app-password'
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    
    # ===== ĞœĞĞ Ğ¨Ğ Ğ£Ğ¢Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞ›Ğ•Ğ Ğ¢ĞĞ’ =====
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'default'
      routes:
      
      # ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ - Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾
      - match:
          severity: critical
        receiver: 'critical-alerts'
        group_wait: 0s
        repeat_interval: 5m
      
      # ĞĞ»ĞµÑ€Ñ‚Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
      - match:
          alert_type: performance
        receiver: 'performance-alerts'
        repeat_interval: 15m
      
      # Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹
      - match:
          alert_type: infrastructure
        receiver: 'infrastructure-alerts'
        repeat_interval: 30m
    
    # ===== ĞŸĞĞ›Ğ£Ğ§ĞĞ¢Ğ•Ğ›Ğ˜ Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ™ =====
    receivers:
    
    # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    - name: 'default'
      email_configs:
      - to: 'admin@fraud-detection.local'
        subject: 'âš ï¸ Fraud Detection Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ ALERT: {{ .GroupLabels.alertname }}
          
          ğŸ“Š Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - Description: {{ .Annotations.description }}
          - Severity: {{ .Labels.severity }}
          - Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          ğŸ”— Dashboard: http://grafana.monitoring.svc.cluster.local:3000
          ğŸ”— Prometheus: http://prometheus.monitoring.svc.cluster.local:9090
    
    # ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ - ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğ¼Ñƒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
    - name: 'critical-alerts'
      email_configs:
      - to: 'sysadmin@fraud-detection.local, on-call@fraud-detection.local'
        subject: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }} - IMMEDIATE ACTION REQUIRED'
        body: |
          ğŸš¨ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ ĞĞ›Ğ•Ğ Ğ¢ ğŸš¨
          
          âš¡ Alertname: {{ .GroupLabels.alertname }}
          ğŸ·ï¸ Service: {{ .GroupLabels.service }}
          ğŸ“ Cluster: {{ .GroupLabels.cluster }}
          
          ğŸ“Š Ğ”Ğ•Ğ¢ĞĞ›Ğ˜:
          {{ range .Alerts }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ¯ Summary: {{ .Annotations.summary }}
          ğŸ“ Description: {{ .Annotations.description }}
          ğŸ”´ Severity: {{ .Labels.severity }}
          â° Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Labels.pod }}ğŸ“¦ Pod: {{ .Labels.pod }}{{ end }}
          {{ if .Labels.instance }}ğŸ–¥ï¸ Instance: {{ .Labels.instance }}{{ end }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {{ end }}
          
          ğŸ”§ Ğ¢Ğ Ğ•Ğ‘Ğ£Ğ•ĞœĞ«Ğ• Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯:
          1. ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ°
          2. ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ² Grafana
          3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹
          4. ĞŸÑ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ - ÑÑĞºĞ°Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾ DevOps ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
          
          ğŸ”— ĞŸĞĞ›Ğ•Ğ—ĞĞ«Ğ• Ğ¡Ğ¡Ğ«Ğ›ĞšĞ˜:
          â€¢ Grafana Dashboard: http://grafana.monitoring.svc.cluster.local:3000/d/fraud-detection
          â€¢ Prometheus Alerts: http://prometheus.monitoring.svc.cluster.local:9090/alerts
          â€¢ Kubernetes Dashboard: kubectl get pods -n fraud-detection
          
          âš ï¸ Ğ­Ñ‚Ğ¾Ñ‚ Ğ°Ğ»ĞµÑ€Ñ‚ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ ĞĞ•ĞœĞ•Ğ”Ğ›Ğ•ĞĞĞĞ“Ğ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ!
      
      slack_configs:
      - channel: '#alerts-critical'
        title: 'ğŸš¨ CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        text: |
          ğŸš¨ **ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ ĞĞ›Ğ•Ğ Ğ¢**
          
          **Service:** {{ .GroupLabels.service }}
          **Alert:** {{ .GroupLabels.alertname }}
          **Severity:** {{ .GroupLabels.severity }}
          
          {{ range .Alerts }}
          **Summary:** {{ .Annotations.summary }}
          **Started:** {{ .StartsAt.Format "15:04:05" }}
          {{ end }}
          
          ğŸ”— <http://grafana.monitoring.svc.cluster.local:3000|Grafana Dashboard>
        send_resolved: true
    
    # ĞĞ»ĞµÑ€Ñ‚Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
    - name: 'performance-alerts'
      email_configs:
      - to: 'performance-team@fraud-detection.local'
        subject: 'ğŸ“ˆ Performance Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸ“ˆ PERFORMANCE ALERT
          
          ğŸ¯ Alert: {{ .GroupLabels.alertname }}
          ğŸ·ï¸ Service: {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          ğŸ“Š Summary: {{ .Annotations.summary }}
          ğŸ“ Details: {{ .Annotations.description }}
          â° Duration: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          ğŸ”§ Recommended Actions:
          â€¢ Check resource utilization
          â€¢ Review application metrics
          â€¢ Consider scaling if needed
          
          ğŸ”— Performance Dashboard: http://grafana.monitoring.svc.cluster.local:3000/d/performance
      
      slack_configs:
      - channel: '#performance'
        title: 'ğŸ“ˆ Performance Alert: {{ .GroupLabels.alertname }}'
        text: |
          ğŸ“ˆ **Performance issue detected**
          
          {{ range .Alerts }}
          **Summary:** {{ .Annotations.summary }}
          **Service:** {{ .Labels.service }}
          {{ end }}
        send_resolved: true
    
    # Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹
    - name: 'infrastructure-alerts'
      email_configs:
      - to: 'devops@fraud-detection.local'
        subject: 'ğŸ—ï¸ Infrastructure Alert: {{ .GroupLabels.alertname }}'
        body: |
          ğŸ—ï¸ INFRASTRUCTURE ALERT
          
          ğŸ¯ Alert: {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          ğŸ“Š Summary: {{ .Annotations.summary }}
          ğŸ“ Details: {{ .Annotations.description }}
          â° Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          ğŸ”§ Infrastructure Dashboard: http://grafana.monitoring.svc.cluster.local:3000/d/infrastructure

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: server
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: alertmanager
      app.kubernetes.io/component: server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: alertmanager
        app.kubernetes.io/component: server
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.25.0
        args:
        - '--config.file=/etc/alertmanager/alertmanager.yml'
        - '--storage.path=/alertmanager'
        - '--web.external-url=http://alertmanager.monitoring.svc.cluster.local:9093'
        ports:
        - name: http
          containerPort: 9093
        volumeMounts:
        - name: alertmanager-config
          mountPath: /etc/alertmanager
        - name: alertmanager-storage
          mountPath: /alertmanager
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: alertmanager-config
        configMap:
          name: alertmanager-config
      - name: alertmanager-storage
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: server
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9093
    targetPort: 9093
  selector:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: server
