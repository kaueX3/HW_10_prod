apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'fraud-detection-cluster'
        environment: 'production'
    
    # ===== ALERTING RULES =====
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    
    # ===== ALERTMANAGER CONFIGURATION =====
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    # ===== SCRAPE CONFIGURATIONS =====
    scrape_configs:
    
    # Prometheus itself
    - job_name: 'prometheus'
      static_configs:
        - targets: ['localhost:9090']
    
    # Kubernetes API Server
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
    
    # Kubernetes Nodes
    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics
    
    # cAdvisor –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ—Ç—Ä–∏–∫
    - job_name: 'kubernetes-cadvisor'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
    
    # Kubernetes Pods
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
    
    # Fraud Detection API - –æ—Å–Ω–æ–≤–Ω–æ–π target
    - job_name: 'fraud-detection-api'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
          - fraud-detection
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: fraud-detection-service
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: metrics
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_service_name]
        target_label: kubernetes_service_name
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: kubernetes_pod_name
    
    # MLflow Server
    - job_name: 'mlflow-server'
      static_configs:
        - targets: ['mlflow-server.airflow.svc.cluster.local:5000']
      metrics_path: '/metrics'
      scrape_interval: 30s
    
    # Airflow
    - job_name: 'airflow'
      static_configs:
        - targets: ['airflow-webserver.airflow.svc.cluster.local:8080']
      metrics_path: '/admin/metrics'
      scrape_interval: 30s
    
    # Node Exporter (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    - job_name: 'node-exporter'
      kubernetes_sd_configs:
      - role: endpoints
      relabel_configs:
      - source_labels: [__meta_kubernetes_endpoints_name]
        regex: 'node-exporter'
        action: keep
    
    # Kafka (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    - job_name: 'kafka'
      static_configs:
        - targets: ['kafka:9308']  # JMX exporter port
      scrape_interval: 30s

  # ===== ALERTING RULES =====
  alert_rules.yml: |
    groups:
    - name: fraud_detection_alerts
      rules:
      
      # ===== HIGH LOAD ALERT (–æ—Å–Ω–æ–≤–Ω–æ–π –∞–ª–µ—Ä—Ç) =====
      - alert: FraudDetectionHighLoad
        expr: |
          (
            rate(container_cpu_usage_seconds_total{namespace="fraud-detection", pod=~"fraud-detection-api-.*"}[5m]) * 100 > 80
          ) and (
            count(up{job="fraud-detection-api"} == 1) >= 6
          )
        for: 5m
        labels:
          severity: critical
          service: fraud-detection
          alert_type: performance
        annotations:
          summary: "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–ì–†–£–ó–ö–ê: 6 —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ API —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π >80%"
          description: |
            üî• –í–ù–ò–ú–ê–ù–ò–ï! Fraud Detection API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:
            
            üìä –°—Ç–∞—Ç—É—Å: {{ $value }}% CPU load –Ω–∞ {{ $labels.pod }}
            ‚öñÔ∏è –≠–∫–∑–µ–º–ø–ª—è—Ä–æ–≤: 6 (–º–∞–∫—Å–∏–º—É–º)
            ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ .ForString }}
            üïí –í—Ä–µ–º—è: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            
            üéØ –ù–ï–û–ë–•–û–î–ò–ú–´–ï –î–ï–ô–°–¢–í–ò–Ø:
            ‚Ä¢ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
            ‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤
            ‚Ä¢ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫
            ‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            
            üìà Troubleshooting: kubectl top pods -n fraud-detection
      
      # ===== SCALING TO MAX REPLICAS =====
      - alert: FraudDetectionMaxReplicas
        expr: |
          kube_deployment_status_replicas{namespace="fraud-detection", deployment="fraud-detection-api"} >= 6
        for: 2m
        labels:
          severity: warning
          service: fraud-detection
          alert_type: scaling
        annotations:
          summary: "‚ö†Ô∏è Fraud Detection API –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω –¥–æ –º–∞–∫—Å–∏–º—É–º–∞ (6 —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤)"
          description: |
            üöÄ Fraud Detection API –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–ø–ª–∏–∫
            
            üìä –¢–µ–∫—É—â–∏—Ö —Ä–µ–ø–ª–∏–∫: {{ $value }}
            üéØ –ú–∞–∫—Å–∏–º—É–º: 6
            ‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ: {{ .ForString }}
            
            üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –æ –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
      
      # ===== HIGH MEMORY USAGE =====
      - alert: FraudDetectionHighMemoryUsage
        expr: |
          (container_memory_working_set_bytes{namespace="fraud-detection", pod=~"fraud-detection-api-.*"} / container_spec_memory_limit_bytes{namespace="fraud-detection", pod=~"fraud-detection-api-.*"}) * 100 > 85
        for: 3m
        labels:
          severity: warning
          service: fraud-detection
          alert_type: resources
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ Fraud Detection API"
          description: |
            üìà –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: {{ $value }}% –Ω–∞ {{ $labels.pod }}
            ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ .ForString }}
            
            üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
      
      # ===== HIGH RESPONSE TIME =====
      - alert: FraudDetectionHighLatency
        expr: |
          histogram_quantile(0.95, rate(ml_prediction_duration_seconds_bucket{job="fraud-detection-api"}[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
          service: fraud-detection
          alert_type: performance
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ Fraud Detection API"
          description: |
            ‚è±Ô∏è P95 Latency: {{ $value }}s
            üéØ –ü–æ—Ä–æ–≥: 500ms
            ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ .ForString }}
            
            üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ inference pipeline
      
      # ===== HIGH ERROR RATE =====
      - alert: FraudDetectionHighErrorRate
        expr: |
          (rate(ml_prediction_errors_total{job="fraud-detection-api"}[5m]) / rate(ml_predictions_total{job="fraud-detection-api"}[5m])) * 100 > 5
        for: 2m
        labels:
          severity: critical
          service: fraud-detection
          alert_type: errors
        annotations:
          summary: "üö® –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ –≤ Fraud Detection API"
          description: |
            üìä Error Rate: {{ $value }}%
            üéØ –ü–æ—Ä–æ–≥: 5%
            ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ .ForString }}
            
            üîß –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–µ–ª–∏
      
      # ===== SERVICE DOWN =====
      - alert: FraudDetectionServiceDown
        expr: |
          up{job="fraud-detection-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: fraud-detection
          alert_type: availability
        annotations:
          summary: "üö® Fraud Detection API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          description: |
            üí• –≠–∫–∑–µ–º–ø–ª—è—Ä {{ $labels.instance }} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            ‚è±Ô∏è –í—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: {{ .ForString }}
            
            üîß –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–æ–≤ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
      
      # ===== LOW PREDICTION RATE =====
      - alert: FraudDetectionLowPredictionRate
        expr: |
          rate(ml_predictions_total{job="fraud-detection-api"}[5m]) < 1
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
          alert_type: business
        annotations:
          summary: "‚ö†Ô∏è –ù–∏–∑–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –≤ Fraud Detection API"
          description: |
            üìä –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É: {{ $value }}
            üéØ –û–∂–∏–¥–∞–µ—Ç—Å—è: >1 RPS
            ‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ .ForString }}
            
            üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –∏ —Ä–∞–±–æ—Ç—É –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
    
    # ===== KUBERNETES CLUSTER ALERTS =====
    - name: kubernetes_alerts
      rules:
      
      - alert: KubernetesNodeNotReady
        expr: |
          kube_node_status_condition{condition="Ready", status="true"} == 0
        for: 3m
        labels:
          severity: critical
          alert_type: infrastructure
        annotations:
          summary: "üö® Kubernetes —É–∑–µ–ª –Ω–µ –≥–æ—Ç–æ–≤"
          description: "–£–∑–µ–ª {{ $labels.node }} –Ω–µ –≥–æ—Ç–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ {{ .ForString }}"
      
      - alert: KubernetesPodCrashLooping
        expr: |
          kube_pod_container_status_restarts_total{namespace="fraud-detection"} > 5
        for: 1m
        labels:
          severity: warning
          alert_type: infrastructure
        annotations:
          summary: "‚ö†Ô∏è –ü–æ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ"
          description: "–ü–æ–¥ {{ $labels.pod }} –≤ namespace {{ $labels.namespace }} –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è {{ $value }} —Ä–∞–∑"
